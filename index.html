<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Detection AI - Sistema de Detecci√≥n de Desechos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Outfit', system-ui, sans-serif; background: #060b18; margin: 0; }
        .gradient-bg {
            background: radial-gradient(ellipse 80% 60% at 50% -20%, rgba(16,185,129,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse 60% 40% at 80% 80%, rgba(59,130,246,0.05) 0%, transparent 50%), #060b18;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(15,23,42,0.6); backdrop-filter: blur(20px); border: 1px solid rgba(148,163,184,0.08); }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.2); border-radius: 3px; }
        @keyframes pulse-amber { 0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)} 50%{box-shadow:0 0 0 6px rgba(245,158,11,0)} }
        .pulse-amber { animation: pulse-amber 2s ease-in-out infinite; }
        .tab-content { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
        @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
        .skeleton { background:linear-gradient(90deg,rgba(30,41,59,0.5) 25%,rgba(51,65,85,0.5) 50%,rgba(30,41,59,0.5) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
<div id="root"></div>
<script type="text/babel">
const { useState, useCallback, useRef, useEffect, useMemo } = React;

const API_BASE_URL = '__API_URL__';

const CLASS_COLORS = { biodegradable:'#10B981', cardboard:'#8B5CF6', glass:'#06B6D4', metal:'#6B7280', paper:'#F59E0B', plastic:'#3B82F6' };
const CLASS_ICONS = { biodegradable:'üçé', cardboard:'üì¶', glass:'üçæ', metal:'ü•´', paper:'üìÑ', plastic:'üß¥' };
const VSTATUS = {
    pending:      { label:'Pendiente',   color:'text-slate-400',   bg:'bg-slate-500/10',   border:'border-slate-500/20',   icon:'‚è≥' },
    needs_review: { label:'A Verificar', color:'text-amber-400',   bg:'bg-amber-500/10',   border:'border-amber-500/20',   icon:'‚ö†Ô∏è' },
    verified:     { label:'Verificada',  color:'text-emerald-400', bg:'bg-emerald-500/10',  border:'border-emerald-500/20', icon:'‚úÖ' },
    corrected:    { label:'Corregida',   color:'text-blue-400',    bg:'bg-blue-500/10',     border:'border-blue-500/20',    icon:'‚úèÔ∏è' },
    discarded:    { label:'Descartada',  color:'text-red-400',     bg:'bg-red-500/10',      border:'border-red-500/20',     icon:'üóëÔ∏è' },
};

// ‚îÄ‚îÄ‚îÄ Icons ‚îÄ‚îÄ‚îÄ
const I = {
    Upload:({s=32})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
    Trash2:({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    Camera:({s=18})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
    BarChart:({s=18})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
    Activity:({s=18})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
    Check:({s=12})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
    X:({s=20})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
    Loader:({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg" className="animate-spin"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
    Zap:({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
    Refresh:({s=18})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    Clock:({s=20})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    Img:({s=20})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
    Server:({s=20})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>,
    DB:({s=20})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
    Clip:({s=18})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M9 14l2 2 4-4"/></svg>,
};

// ‚îÄ‚îÄ‚îÄ Status Badge ‚îÄ‚îÄ‚îÄ
function SBadge({ status, pulse }) {
    if (['healthy','demo','degraded','offline','error'].includes(status)) {
        const ok = status==='healthy'||status==='demo';
        return <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium mono ${ok?'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20':'bg-red-500/10 text-red-400 border border-red-500/20'}`}>
            <span className={`w-1.5 h-1.5 rounded-full ${ok?'bg-emerald-400':'bg-red-400'}`}/>{status==='demo'?'DEMO':status.toUpperCase()}
        </span>;
    }
    const v = VSTATUS[status]||VSTATUS.pending;
    return <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${v.bg} ${v.color} border ${v.border} ${pulse?'pulse-amber':''}`}>{v.icon} {v.label}</span>;
}

// ‚îÄ‚îÄ‚îÄ Confidence Bar ‚îÄ‚îÄ‚îÄ
function CBar({ value }) {
    const p = value*100;
    const c = p>=70?'bg-emerald-500':p>=50?'bg-amber-500':'bg-red-500';
    const t = p>=70?'text-emerald-400':p>=50?'text-amber-400':'text-red-400';
    return <div className="flex items-center gap-2 w-full">
        <div className="flex-1 h-1.5 bg-slate-700/50 rounded-full overflow-hidden"><div className={`h-1.5 ${c} rounded-full`} style={{width:`${p}%`}}/></div>
        <span className={`mono text-xs font-semibold ${t}`}>{p.toFixed(1)}%</span>
    </div>;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REVIEW PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ReviewPanel() {
    const [queue, setQueue] = useState([]);
    const [sCounts, setSCounts] = useState({});
    const [loading, setLoading] = useState(true);
    const [idx, setIdx] = useState(0);
    const [filter, setFilter] = useState(null);
    const [busy, setBusy] = useState(false);
    const [editMode, setEditMode] = useState(false);
    const [editDets, setEditDets] = useState([]);
    const [classes, setClasses] = useState([]);

    useEffect(() => {
        fetch(`${API_BASE_URL}/review/classes`).then(r=>r.ok?r.json():null).then(d=>{if(d)setClasses(d.classes)}).catch(()=>{});
    }, []);

    const load = useCallback(async () => {
        setLoading(true);
        try {
            const p = new URLSearchParams({limit:'30',offset:'0'});
            if (filter) p.set('status', filter);
            const res = await fetch(`${API_BASE_URL}/review/queue?${p}`);
            if (res.ok) { const d = await res.json(); setQueue(d.records); setSCounts(d.status_counts); setIdx(0); setEditMode(false); }
        } catch(e) { console.error(e); }
        setLoading(false);
    }, [filter]);

    useEffect(() => { load(); }, [load]);

    const cur = queue[idx] || null;

    const doAction = async (action) => {
        if (!cur) return;
        setBusy(true);
        try {
            let body;
            if (action==='verify') body = {status:'verified',verified_by:'reviewer'};
            else if (action==='reject') body = {status:'needs_review',verified_by:'reviewer'};
            else if (action==='discard') body = {status:'discarded',verified_by:'reviewer'};
            else if (action==='correct') body = {status:'corrected',verified_by:'reviewer',verified_detections:editDets.map(d=>({class_name:d.class_name,class_id:d.class_id,confidence:d.confidence,bbox:d.bbox}))};

            const res = await fetch(`${API_BASE_URL}/review/${cur.request_id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
            if (res.ok) {
                const nq = queue.filter((_,i)=>i!==idx);
                setQueue(nq);
                if (idx>=nq.length) setIdx(Math.max(0,nq.length-1));
                setEditMode(false);
                // refresh counts
                fetch(`${API_BASE_URL}/review/stats`).then(r=>r.ok?r.json():null).then(d=>{
                    if(d&&d.counts) setSCounts(d.counts);
                }).catch(()=>{});
            }
        } catch(e) { console.error(e); }
        setBusy(false);
    };

    const startEdit = () => { if(cur) { setEditDets(JSON.parse(JSON.stringify(cur.detections))); setEditMode(true); } };

    const totalPending = (sCounts.pending||0)+(sCounts.needs_review||0);

    return <div className="tab-content space-y-6">
        {/* Stats */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
                {l:'Pendientes',v:totalPending,from:'from-amber-500/20',to:'to-amber-600/5',b:'border-amber-500/15',t:'text-amber-300'},
                {l:'Verificadas',v:sCounts.verified||0,from:'from-emerald-500/20',to:'to-emerald-600/5',b:'border-emerald-500/15',t:'text-emerald-300'},
                {l:'Corregidas',v:sCounts.corrected||0,from:'from-blue-500/20',to:'to-blue-600/5',b:'border-blue-500/15',t:'text-blue-300'},
                {l:'Descartadas',v:sCounts.discarded||0,from:'from-red-500/20',to:'to-red-600/5',b:'border-red-500/15',t:'text-red-300'},
            ].map((x,i)=><div key={i} className={`bg-gradient-to-br ${x.from} ${x.to} rounded-2xl p-5 border ${x.b}`}>
                <p className={`text-3xl font-bold mono ${x.t}`}>{x.v}</p><p className="text-sm text-slate-400 mt-1">{x.l}</p>
            </div>)}
        </div>

        {/* Filters */}
        <div className="flex items-center gap-2 flex-wrap">
            <span className="text-xs text-slate-500 uppercase tracking-wider mr-2">Filtrar:</span>
            {[{k:null,l:'Todo pendiente'},{k:'needs_review',l:'‚ö†Ô∏è A verificar'},{k:'pending',l:'‚è≥ Sin revisar'},{k:'verified',l:'‚úÖ Verificadas'},{k:'corrected',l:'‚úèÔ∏è Corregidas'}].map(f=>
                <button key={f.k||'all'} onClick={()=>setFilter(f.k)} className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${filter===f.k?'bg-slate-700 text-white':'text-slate-400 hover:text-slate-200 hover:bg-slate-800'}`}>{f.l}</button>
            )}
            <button onClick={load} className="ml-auto p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg"><I.Refresh/></button>
        </div>

        {/* Main review area */}
        {loading ? <div className="space-y-4"><div className="skeleton h-64 w-full"/><div className="skeleton h-12 w-3/4"/></div>
        : queue.length===0 ? <div className="glass rounded-2xl p-16 text-center"><span className="text-5xl block mb-4">üéâ</span><p className="text-xl font-semibold text-white mb-2">¬°Cola vac√≠a!</p><p className="text-slate-400">No hay im√°genes con el filtro seleccionado.</p></div>
        : cur && <div className="grid lg:grid-cols-5 gap-6">
            {/* Left: detections info */}
            <div className="lg:col-span-3 space-y-4">
                <div className="glass rounded-2xl p-6">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <span className="text-slate-400 mono text-xs">ID: {cur.request_id.slice(0,8)}...</span>
                            <SBadge status={cur.verification_status} pulse={cur.verification_status==='needs_review'}/>
                        </div>
                        <span className="mono text-xs text-slate-500">{idx+1} / {queue.length}</span>
                    </div>

                    {/* Image placeholder - en producci√≥n servir imagen desde signed URL */}
                    <div className="bg-slate-800/80 rounded-xl p-8 flex flex-col items-center justify-center min-h-[200px] border border-slate-700/30 mb-4">
                        <span className="text-slate-600 mb-3"><I.Img s={48}/></span>
                        <p className="text-slate-500 text-sm text-center">Imagen almacenada en GCS</p>
                        {cur.image_url && <p className="mono text-xs text-slate-600 mt-2 break-all max-w-md text-center">{cur.image_url}</p>}
                    </div>

                    {/* Meta info */}
                    <div className="grid grid-cols-3 gap-3 mb-4">
                        <div className="bg-slate-800/50 rounded-xl p-3 text-center">
                            <p className="text-2xl font-bold text-white">{cur.detection_count}</p>
                            <p className="text-xs text-slate-400">Detecciones</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-xl p-3 text-center">
                            <p className="text-2xl font-bold text-white">{cur.min_confidence != null ? (cur.min_confidence*100).toFixed(0)+'%' : 'N/A'}</p>
                            <p className="text-xs text-slate-400">Conf. M√≠n.</p>
                        </div>
                        <div className="bg-slate-800/50 rounded-xl p-3 text-center">
                            <p className="text-lg font-bold text-white truncate">{cur.model_version}</p>
                            <p className="text-xs text-slate-400">Modelo</p>
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="flex items-center justify-between">
                        <button onClick={()=>setIdx(Math.max(0,idx-1))} disabled={idx===0}
                            className="px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-1">
                            ‚Üê Anterior
                        </button>
                        <button onClick={()=>setIdx(Math.min(queue.length-1,idx+1))} disabled={idx>=queue.length-1}
                            className="px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-1">
                            Siguiente ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            {/* Right: Detections list + actions */}
            <div className="lg:col-span-2 space-y-4">
                {/* Detection list */}
                <div className="glass rounded-2xl p-5">
                    <h4 className="text-sm font-semibold text-slate-300 mb-3 uppercase tracking-wider">
                        {editMode ? '‚úèÔ∏è Editando detecciones' : 'Detecciones del modelo'}
                    </h4>
                    <div className="space-y-2 max-h-72 overflow-y-auto">
                        {(editMode ? editDets : cur.detections).map((det, di) => (
                            <div key={di} className="flex items-center gap-3 bg-slate-800/50 rounded-lg p-3">
                                <span className="text-xl">{CLASS_ICONS[det.class_name]||'üì¶'}</span>
                                <div className="flex-1 min-w-0">
                                    {editMode ? (
                                        <select value={det.class_id} onChange={e=>{
                                            const nc = classes.find(c=>c.id===Number(e.target.value));
                                            if(nc){const cp=[...editDets];cp[di]={...cp[di],class_id:nc.id,class_name:nc.name};setEditDets(cp);}
                                        }} className="w-full bg-slate-700 text-white rounded px-2 py-1 text-sm border border-slate-600 focus:border-blue-500 outline-none">
                                            {classes.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    ) : (
                                        <p className="font-medium text-white capitalize text-sm">{det.class_name}</p>
                                    )}
                                    <CBar value={det.confidence}/>
                                </div>
                                {editMode && <button onClick={()=>setEditDets(prev=>prev.filter((_,i)=>i!==di))} className="text-red-400 hover:text-red-300 p-1"><I.X s={16}/></button>}
                            </div>
                        ))}
                        {(editMode ? editDets : cur.detections).length === 0 && (
                            <p className="text-slate-500 text-sm text-center py-4">Sin detecciones</p>
                        )}
                    </div>
                </div>

                {/* Action buttons */}
                <div className="glass rounded-2xl p-5 space-y-3">
                    <h4 className="text-sm font-semibold text-slate-300 mb-2 uppercase tracking-wider">Acciones</h4>
                    
                    {!editMode ? <>
                        <button onClick={()=>doAction('verify')} disabled={busy}
                            className="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 bg-emerald-500/15 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/25 transition-all disabled:opacity-50">
                            ‚úÖ Correcta - Verificar
                        </button>
                        <button onClick={startEdit} disabled={busy}
                            className="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 bg-blue-500/15 text-blue-400 border border-blue-500/20 hover:bg-blue-500/25 transition-all disabled:opacity-50">
                            ‚úèÔ∏è Incorrecta - Corregir etiquetas
                        </button>
                        <button onClick={()=>doAction('discard')} disabled={busy}
                            className="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all disabled:opacity-50">
                            üóëÔ∏è Descartar imagen
                        </button>
                    </> : <>
                        <button onClick={()=>doAction('correct')} disabled={busy || editDets.length===0}
                            className="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 bg-blue-500/20 text-blue-300 border border-blue-500/30 hover:bg-blue-500/30 transition-all disabled:opacity-50">
                            {busy ? <I.Loader s={16}/> : null} Guardar correcciones
                        </button>
                        <button onClick={()=>setEditMode(false)}
                            className="w-full py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 bg-slate-700/50 text-slate-400 hover:text-white transition-all">
                            Cancelar
                        </button>
                    </>}

                    {cur.min_confidence != null && cur.min_confidence < 0.5 && (
                        <div className="mt-2 bg-amber-500/10 border border-amber-500/20 rounded-xl p-3 text-amber-400 text-xs">
                            ‚ö†Ô∏è Confianza m√≠nima bajo 50% ‚Äî marcada autom√°ticamente para revisi√≥n.
                        </div>
                    )}
                </div>
            </div>
        </div>}
    </div>;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function WasteDetectionApp() {
    const [tab, setTab] = useState('detect');
    const [image, setImage] = useState(null);
    const [preview, setPreview] = useState(null);
    const [detections, setDetections] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [health, setHealth] = useState({status:'demo',model_loaded:true,database_connected:true,storage_connected:true,model_version:'demo'});
    const [metrics, setMetrics] = useState({total_inferences:0,avg_inference_time_ms:0,requests_last_hour:0,uptime_seconds:0});
    const [history, setHistory] = useState([]);
    const [feedbackSent, setFeedbackSent] = useState({});
    const fileRef = useRef(null);
    const canvasRef = useRef(null);

    useEffect(() => { if(detections && preview && canvasRef.current) drawDetections(); }, [detections, preview]);

    useEffect(() => {
        const check = async () => {
            try { const r = await fetch(`${API_BASE_URL}/health`); if(r.ok) setHealth(await r.json()); } catch(e) { setHealth(p=>({...p,status:'offline'})); }
            try { const r = await fetch(`${API_BASE_URL}/metrics`); if(r.ok) setMetrics(await r.json()); } catch(e) {}
        };
        check();
        const iv = setInterval(check, 30000);
        return ()=>clearInterval(iv);
    }, []);

    const handleFile = useCallback(e => {
        const f = e.target.files?.[0];
        if(f) { setImage(f); setDetections(null); setError(null); setFeedbackSent({});
            const r = new FileReader(); r.onload=e=>setPreview(e.target.result); r.readAsDataURL(f);
        }
    }, []);

    const handleDrop = useCallback(e => {
        e.preventDefault();
        const f = e.dataTransfer.files?.[0];
        if(f && f.type.startsWith('image/')) { setImage(f); setDetections(null); setError(null); setFeedbackSent({});
            const r = new FileReader(); r.onload=e=>setPreview(e.target.result); r.readAsDataURL(f);
        }
    }, []);

    const analyze = async () => {
        if(!image) return;
        setLoading(true); setError(null); setFeedbackSent({});
        try {
            const fd = new FormData(); fd.append('file', image);
            const res = await fetch(`${API_BASE_URL}/predict?save_image=true`,{method:'POST',body:fd});
            if(!res.ok) throw new Error(`Error ${res.status}`);
            const result = await res.json();
            setDetections(result);
            setHistory(p=>[{id:result.request_id,timestamp:new Date().toLocaleString(),detections:result.detection_count,time_ms:result.inference_time_ms},...p.slice(0,9)]);
        } catch(e) { setError(e.message); } finally { setLoading(false); }
    };

    const sendFeedback = async (requestId, isCorrect) => {
        try {
            const res = await fetch(`${API_BASE_URL}/review/${requestId}/feedback`,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body: JSON.stringify({is_correct:isCorrect,user_id:'web_user'})
            });
            if(res.ok) {
                const data = await res.json();
                setFeedbackSent({sent:true, message:data.message, forced:data.forced_review});
            }
        } catch(e) { console.error(e); }
    };

    const drawDetections = () => {
        const canvas = canvasRef.current; const ctx = canvas.getContext('2d'); const img = new Image();
        img.onload = () => {
            canvas.width=img.width; canvas.height=img.height; ctx.drawImage(img,0,0);
            detections.detections.forEach(det => {
                const [x1,y1,x2,y2] = det.bbox;
                const color = CLASS_COLORS[det.class_name]||'#3B82F6';
                ctx.strokeStyle=color; ctx.lineWidth=3; ctx.strokeRect(x1,y1,x2-x1,y2-y1);
                const label=`${CLASS_ICONS[det.class_name]||''} ${det.class_name} ${(det.confidence*100).toFixed(1)}%`;
                ctx.font='bold 14px Outfit, Arial'; const tw=ctx.measureText(label).width;
                ctx.fillStyle=color; ctx.fillRect(x1,y1-24,tw+12,24);
                ctx.fillStyle='white'; ctx.fillText(label,x1+6,y1-7);
            });
        };
        img.src = preview;
    };

    const clear = () => { setImage(null); setPreview(null); setDetections(null); setError(null); setFeedbackSent({}); if(fileRef.current) fileRef.current.value=''; };

    const TABS = [
        {id:'detect',label:'Detectar',icon:I.Camera},
        {id:'review',label:'Verificar',icon:I.Clip},
        {id:'metrics',label:'M√©tricas',icon:I.BarChart},
        {id:'status',label:'Estado',icon:I.Activity},
    ];

    return <div className="min-h-screen">
        {/* Header */}
        <header className="glass border-b border-slate-700/30">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/20"><I.Trash2 s={20}/></div>
                    <div><h1 className="text-xl font-bold text-white tracking-tight">Waste Detection AI</h1><p className="text-xs text-slate-500">YOLOv8 ¬∑ Clasificaci√≥n de desechos</p></div>
                </div>
                <div className="flex items-center gap-3">
                    <SBadge status={health?.status||'unknown'}/>
                    <button onClick={async()=>{
                        try{const[h,m]=await Promise.all([fetch(`${API_BASE_URL}/health`),fetch(`${API_BASE_URL}/metrics`)]);if(h.ok)setHealth(await h.json());if(m.ok)setMetrics(await m.json());}catch(e){}
                    }} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"><I.Refresh/></button>
                </div>
            </div>
        </header>

        {/* Nav */}
        <div className="max-w-7xl mx-auto px-4 mt-6">
            <div className="flex gap-1 bg-slate-900/50 p-1 rounded-xl w-fit border border-slate-800/50">
                {TABS.map(t=><button key={t.id} onClick={()=>setTab(t.id)}
                    className={`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all ${tab===t.id?'bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg shadow-emerald-500/20':'text-slate-400 hover:text-white hover:bg-slate-800/50'}`}>
                    <t.icon/>{t.label}
                    {t.id==='review' && <span className="ml-1 px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-500/20 text-amber-400">!</span>}
                </button>)}
            </div>
        </div>

        {/* Content */}
        <main className="max-w-7xl mx-auto px-4 py-8">

        {/* ‚îÄ‚îÄ‚îÄ DETECT TAB ‚îÄ‚îÄ‚îÄ */}
        {tab==='detect' && <div className="tab-content grid lg:grid-cols-2 gap-8">
            <div className="space-y-6">
                <div onDrop={handleDrop} onDragOver={e=>e.preventDefault()} onClick={()=>fileRef.current?.click()}
                    className={`relative border-2 border-dashed rounded-2xl p-8 text-center cursor-pointer transition-all ${preview?'border-emerald-500/30 bg-emerald-500/5':'border-slate-700 hover:border-slate-600 bg-slate-900/30'}`}>
                    <input ref={fileRef} type="file" accept="image/*" onChange={handleFile} className="hidden"/>
                    {preview ? <div className="relative">
                        {detections ? <canvas ref={canvasRef} className="max-w-full h-auto rounded-xl mx-auto" style={{maxHeight:'400px'}}/> : <img src={preview} alt="" className="max-w-full max-h-96 rounded-xl mx-auto"/>}
                        <button onClick={e=>{e.stopPropagation();clear();}} className="absolute top-2 right-2 p-2 bg-red-500/80 text-white rounded-lg hover:bg-red-500"><I.X/></button>
                    </div> : <div className="py-12">
                        <div className="w-16 h-16 bg-slate-800/50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-slate-500"><I.Upload/></div>
                        <p className="text-slate-300 font-medium mb-2">Arrastra una imagen o haz clic</p>
                        <p className="text-slate-500 text-sm">JPG, PNG, WEBP</p>
                    </div>}
                </div>
                <button onClick={analyze} disabled={!image||loading}
                    className={`w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 transition-all ${!image||loading?'bg-slate-800 text-slate-500 cursor-not-allowed':'bg-gradient-to-r from-emerald-500 to-green-600 text-white hover:shadow-lg hover:shadow-emerald-500/25'}`}>
                    {loading?<><I.Loader/> Analizando...</>:<><I.Zap/> Analizar Imagen</>}
                </button>
                {error && <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4 text-red-400"><p className="font-medium">Error</p><p className="text-sm mt-1">{error}</p></div>}
            </div>

            <div className="space-y-6">
                <div className="glass rounded-2xl p-6">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><span className="text-emerald-400"><I.Img/></span>Resultados</h3>
                    {detections ? <div className="space-y-4">
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-slate-800/50 rounded-xl p-3 text-center"><p className="text-2xl font-bold text-white">{detections.detection_count}</p><p className="text-xs text-slate-400">Objetos</p></div>
                            <div className="bg-slate-800/50 rounded-xl p-3 text-center"><p className="text-2xl font-bold text-white">{detections.inference_time_ms.toFixed(0)}</p><p className="text-xs text-slate-400">ms</p></div>
                            <div className="bg-slate-800/50 rounded-xl p-3 text-center"><p className="text-lg font-bold text-white truncate">{detections.model_version}</p><p className="text-xs text-slate-400">Modelo</p></div>
                        </div>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                            {detections.detections.map((det,i)=><div key={i} className="flex items-center justify-between bg-slate-800/30 rounded-lg p-3">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">{CLASS_ICONS[det.class_name]||'üì¶'}</span>
                                    <div><p className="font-medium text-white capitalize">{det.class_name}</p><p className="text-xs text-slate-500 mono">{det.bbox.map(b=>b.toFixed(0)).join(', ')}</p></div>
                                </div>
                                <div className="w-28"><CBar value={det.confidence}/></div>
                            </div>)}
                        </div>

                        {/* User feedback section */}
                        <div className="border-t border-slate-700/30 pt-4 mt-4">
                            <p className="text-sm font-semibold text-slate-300 mb-3">¬øSon correctas las detecciones?</p>
                            {feedbackSent.sent ? (
                                <div className={`rounded-xl p-3 text-sm ${feedbackSent.forced?'bg-amber-500/10 border border-amber-500/20 text-amber-400':'bg-emerald-500/10 border border-emerald-500/20 text-emerald-400'}`}>
                                    {feedbackSent.message}
                                </div>
                            ) : (
                                <div className="flex gap-3">
                                    <button onClick={()=>sendFeedback(detections.request_id,true)}
                                        className="flex-1 py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20 transition-all">
                                        üëç S√≠, correcta
                                    </button>
                                    <button onClick={()=>sendFeedback(detections.request_id,false)}
                                        className="flex-1 py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all">
                                        üëé No, incorrecta
                                    </button>
                                </div>
                            )}
                        </div>
                    </div> : <div className="text-center py-12 text-slate-500"><span className="block mx-auto mb-4 opacity-50"><I.Img/></span><p>Sube una imagen para ver resultados</p></div>}
                </div>

                {history.length>0 && <div className="glass rounded-2xl p-6">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><span className="text-blue-400"><I.Clock/></span>Historial</h3>
                    <div className="space-y-2">{history.map((h,i)=><div key={i} className="flex items-center justify-between bg-slate-800/30 rounded-lg p-3 text-sm">
                        <span className="text-slate-400">{h.timestamp}</span>
                        <div className="flex items-center gap-4"><span className="text-white">{h.detections} obj</span><span className="text-slate-400 mono">{h.time_ms.toFixed(0)}ms</span></div>
                    </div>)}</div>
                </div>}
            </div>
        </div>}

        {/* ‚îÄ‚îÄ‚îÄ REVIEW TAB ‚îÄ‚îÄ‚îÄ */}
        {tab==='review' && <ReviewPanel/>}

        {/* ‚îÄ‚îÄ‚îÄ METRICS TAB ‚îÄ‚îÄ‚îÄ */}
        {tab==='metrics' && <div className="tab-content grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 rounded-2xl p-6 border border-blue-500/15">
                <p className="text-3xl font-bold text-white mono">{metrics.total_inferences.toLocaleString()}</p><p className="text-sm text-slate-400">Total Inferencias</p>
            </div>
            <div className="bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 rounded-2xl p-6 border border-emerald-500/15">
                <p className="text-3xl font-bold text-white mono">{metrics.avg_inference_time_ms.toFixed(1)} ms</p><p className="text-sm text-slate-400">Tiempo Promedio</p>
            </div>
            <div className="bg-gradient-to-br from-purple-500/20 to-purple-600/10 rounded-2xl p-6 border border-purple-500/15">
                <p className="text-3xl font-bold text-white mono">{metrics.requests_last_hour}</p><p className="text-sm text-slate-400">√öltima Hora</p>
            </div>
            <div className="bg-gradient-to-br from-orange-500/20 to-orange-600/10 rounded-2xl p-6 border border-orange-500/15">
                <p className="text-3xl font-bold text-white mono">{Math.floor(metrics.uptime_seconds/3600)}h</p><p className="text-sm text-slate-400">Uptime</p>
            </div>
            <div className="md:col-span-2 lg:col-span-4 glass rounded-2xl p-6">
                <h3 className="text-lg font-semibold text-white mb-6">Clases Soportadas</h3>
                <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
                    {Object.entries(CLASS_COLORS).map(([cn,color])=><div key={cn} className="bg-slate-800/30 rounded-xl p-4 text-center hover:bg-slate-800/50 transition-colors border border-slate-700/20">
                        <span className="text-3xl block mb-2">{CLASS_ICONS[cn]}</span><p className="font-medium capitalize text-sm" style={{color}}>{cn}</p>
                    </div>)}
                </div>
            </div>
        </div>}

        {/* ‚îÄ‚îÄ‚îÄ STATUS TAB ‚îÄ‚îÄ‚îÄ */}
        {tab==='status' && <div className="tab-content grid md:grid-cols-2 gap-6">
            <div className="glass rounded-2xl p-6">
                <h3 className="text-lg font-semibold text-white mb-6 flex items-center gap-2"><span className="text-blue-400"><I.Server/></span>Estado del Sistema</h3>
                <div className="space-y-3">
                    {[
                        {l:'API Status',s:health.status,icon:I.Activity,c:'text-emerald-400'},
                        {l:'Modelo',s:health.model_loaded?'healthy':'error',icon:I.Zap,c:'text-amber-400'},
                        {l:'Base de Datos',s:health.database_connected?'healthy':'error',icon:I.DB,c:'text-purple-400'},
                        {l:'Storage (GCS)',s:health.storage_connected?'healthy':'error',icon:I.Server,c:'text-cyan-400'},
                    ].map((x,i)=><div key={i} className="flex items-center justify-between p-4 bg-slate-800/30 rounded-xl">
                        <div className="flex items-center gap-3"><span className={x.c}><x.icon/></span><span className="text-slate-300">{x.l}</span></div>
                        <SBadge status={x.s}/>
                    </div>)}
                </div>
            </div>
            <div className="glass rounded-2xl p-6">
                <h3 className="text-lg font-semibold text-white mb-6">Informaci√≥n del Modelo</h3>
                <div className="space-y-3">
                    {[
                        {l:'Versi√≥n Activa',v:health.model_version||'N/A'},
                        {l:'Arquitectura',v:'YOLOv8n (Nano)'},
                        {l:'Clases',v:'6 tipos de desechos'},
                        {l:'Framework',v:'FastAPI + Ultralytics'},
                    ].map((x,i)=><div key={i} className="p-4 bg-slate-800/30 rounded-xl">
                        <p className="text-xs text-slate-500 mb-1">{x.l}</p><p className="text-lg font-semibold text-white">{x.v}</p>
                    </div>)}
                </div>
            </div>
        </div>}

        </main>

        <footer className="border-t border-slate-800/30 mt-12">
            <div className="max-w-7xl mx-auto px-4 py-6"><p className="text-center text-slate-600 text-sm">Waste Detection ¬∑ YOLOv8 + FastAPI + GKE ¬∑ Trabajo Final Integrador</p></div>
        </footer>
    </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<WasteDetectionApp />);
</script>
</body>
</html>
